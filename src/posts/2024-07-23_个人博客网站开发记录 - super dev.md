---
id: f0dafd07-89c7-4217-b8cf-8bc594646944
title: 个人博客网站开发记录 - super dev
createTime: 2024-07-23
updateTime:
categories: nodejs
tags:
description:
draft: 1
---

`npm run a & npm run b` 并不能让 a，b 并行，可能是 windows 系统不支持 &，仍然串行执行了。

使用 `child_process` 简单写了个实现并行的方法，但是遇到新问题：通过脚本修改的文件，vite dev server 并不能监听到变化。放 public 里不响应变化（被缓存了），放 public 外面报错。

又尝试新写法：每次监听到 post 变化后重启 vite dev。但是又有新问题了：vite 会提示 port is in use trying another one。因为重启的时候并不能保证前一个 vite 进程已经终止了。也并没有找到类似 `killed` 的回调

```js
import child_process from "node:child_process";

let viteProcess;

// 速度慢，且 vite 会提示 port is in use trying another one
gerenateNewChildAndLogItsOutput("node build/index.js", () => {
  if (viteProcess) {
    viteProcess.kill();
  }
  viteProcess = gerenateNewChildAndLogItsOutput("vite serve");
});
// gerenateNewChildAndLogItsOutput("vite serve");

function gerenateNewChildAndLogItsOutput(cmdstr, cb) {
  const child = child_process.exec(cmdstr);
  // You can also use a variable to save the output
  // for when the script closes later
  var scriptOutput = "";

  child.stdout.setEncoding("utf8");
  child.stdout.on("data", function (data) {
    //Here is where the output goes
    console.log(data);
    data = data.toString();
    scriptOutput += data;
    cb && cb();
  });

  child.stderr.setEncoding("utf8");
  child.stderr.on("data", function (data) {
    console.log("stderr: " + data);
    data = data.toString();
    scriptOutput += data;
  });

  child.on("close", function (code) {
    console.log("closing code: " + code);
    console.log("Full output of script: ", scriptOutput);
  });
  return child;
}
```
