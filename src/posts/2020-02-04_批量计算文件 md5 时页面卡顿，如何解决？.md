---
id: 023a76e9-c7e0-4f47-87e5-bfad786be472
title: 批量计算文件 md5 时页面卡顿，如何解决？
createTime: 2020-02-04
updateTime:
categories: js
tags: 性能优化
description: 同时计算几千个文件的 md5 值时页面卡顿崩溃，怎么解决？通过分块、排队、web-worker 缓解计算压力；添加分页或虚拟列表缓解渲染压力。
---

## 问题描述

上传文件时，拿到 File 对象后用 [js-spark-md5](https://github.com/satazor/js-spark-md5) 计算文件的 md5（获取 File 对象的方法见[《Super Uploader：上传文件、上传文件夹、拖拽上传》](post:e804da0f-9378-4047-83f7-ec37487f2cd9)。

但是同时计算几千个文件的 md5 值，页面会卡顿甚至崩溃。

## 卡顿原因

主要有两方面的压力：计算压力和渲染压力。

## 缓解计算压力

缓解计算压力，有如下三种策略：
| 策略 | 说明 |
|:--|:--|
| 分块 | <span style="color:darkorange">缓解大文件造成的计算压力</span><br>文件很大时，一次性读取整个文件非常非常耗时，而且读取时页面会卡死。<br>所以必须要分块读取文件，并计算 md5（`js-spark-md5` 支持分块）|
| 排队 | <span style="color:darkorange">缓解文件多造成的计算压力</span> <br>同一时刻，只允许运行最多 n 个计算任务，后来的在等待队列中排队。|
|多线程| 使用 [Web Worker](https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API) 多线程计算 md5。<br> **注意 worker 用完必须杀掉。不然数量多了之后，即使没在执行计算任务，浏览器也会崩**|

分块和排队都必须用。多线程可用可不用。

## 缓解渲染压力

如果把所有文件都展示在页面上，那么文件一多，渲染压力就会很大。

在真实的业务场景中，展示的细节可能更丰富，渲染压力会更大。比如：因为是分块上传，所以有上传进度，进度百分比也要在上传列表中展示。这会导致每个任务的上传进度每次改变，浏览器都要重新渲染。

渲染压力没有好的缓解办法。无论如何，成千上万个 div 一下子添加进来，并且一直在变化，浏览器肯定会卡的。

唯一的方案是不要显示太多文件：可以给列表添加分页功能，或者用虚拟滚动列表。我对此兴趣不大，所以就不实现了。
